<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>축의금/조의금 OCR</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
  body { font-family: sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
</style>
</head>
<body>

<h2>축의금/조의금 OCR</h2>
<input type="file" id="imageInput" accept="image/*">
<table id="resultTable">
  <thead>
    <tr>
      <th>번호</th>
      <th>성명</th>
      <th>축의금/조의금</th>
      <th>비고</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const imageInput = document.getElementById('imageInput');
const resultTable = document.getElementById('resultTable').querySelector('tbody');

imageInput.addEventListener('change', async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const imgURL = URL.createObjectURL(file);
  resultTable.innerHTML = '<tr><td colspan="4">OCR 처리 중...</td></tr>';

  const { data: { words } } = await Tesseract.recognize(imgURL, 'kor', { logger: m => console.log(m) });

  // 좌표 기준 행 그룹화 (top 기준)
  const rowThreshold = 10; // 같은 행으로 볼 최소 차이
  let rows = [];
  words.forEach(word => {
    if (word.text.trim() === '' || word.text.includes('합계')) return;
    let added = false;
    for (let row of rows) {
      if (Math.abs(word.bbox.y0 - row.avgTop) < rowThreshold) {
        row.words.push(word);
        row.avgTop = row.words.reduce((sum, w) => sum + w.bbox.y0, 0) / row.words.length;
        added = true;
        break;
      }
    }
    if (!added) {
      rows.push({ words: [word], avgTop: word.bbox.y0 });
    }
  });

  // 각 행에서 좌표 기준 열 정렬
  rows.sort((a, b) => a.avgTop - b.avgTop);
  resultTable.innerHTML = '';
  rows.forEach(row => {
    row.words.sort((a, b) => a.bbox.x0 - b.bbox.x0);

    // 단순 매핑: 번호 / 성명 / 금액 / 비고
    const cells = [];
    cells.push(row.words[0]?.text || '');
    cells.push(row.words[1]?.text || '');
    let amount = row.words[2]?.text.replace(/[^\d]/g,'') || '';
    amount = amount ? parseInt(amount) * 1000 : '';
    cells.push(amount);
    cells.push(row.words.slice(3).map(w => w.text).join(' '));

    const tr = document.createElement('tr');
    cells.forEach(c => {
      const td = document.createElement('td');
      td.textContent = c;
      tr.appendChild(td);
    });
    resultTable.appendChild(tr);
  });
});
</script>

</body>
</html>
