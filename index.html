<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>브라우저 OCR – PaddleOCR + ONNX</title>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
</head>
<body>
  <h2>PaddleOCR (ONNX) Browser OCR</h2>
  <input type="file" id="input" accept="image/*" />
  <canvas id="canvas" style="display: none;"></canvas>
  <pre id="output"></pre>

  <script type="module">
    import { PaddleOcrService } from 'https://cdn.jsdelivr.net/npm/paddleocr@1.0.2/dist/paddleocr.min.js';

    (async () => {
      // ONNX 모델 파일을 fetch로 가져오기
      const detResp = await fetch('ppocr_det.onnx');
      const recResp = await fetch('ppocr_rec.onnx');
      const dictResp = await fetch('ppocr_dict.txt');

      const detBuffer = await detResp.arrayBuffer();
      const recBuffer = await recResp.arrayBuffer();
      const dictText = await dictResp.text();
      const dict = dictText.split('\n').map(s => s.trim());

      // OCR 서비스 생성
      const ocrService = await PaddleOcrService.createInstance({
        ort: ort,  // onnxruntime-web
        detection: { modelBuffer: detBuffer },
        recognition: { modelBuffer: recBuffer, charactersDictionary: dict }
      });

      document.getElementById('input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();

        // 이미지 캔버스로 복사
        const canvas = document.getElementById('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // OCR 실행
        const result = await ocrService.recognize({
          width: canvas.width,
          height: canvas.height,
          data: imageData.data
        });

        document.getElementById('output').textContent = JSON.stringify(result, null, 2);
      });
    })();
  </script>
</body>
</html>
